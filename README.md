# highload VK

Курсовая работа в рамках дисциплины "Проектирование высоконагруженных сервисов"<br> по теме: 
"Сервис по поиску свободных парковочных мест".

**Автор** - Ларин Александр WEB-31

## Содержание
  [1. Тема, функционал и аудитория](#тема)
## 1. Тема, функционал и аудитория

### Тема
В качестве темы был выбран личный проект - сервис, который помогает водителям найти <br> ближайшее свободное парковочное место и сэкономить время.

### Ключевой функционал продукта
- Отображение парковок на карте;
- Просмотр количества свободных мест на выбранной парковке;
- Добавление/удаление избранных парковок.

### Целевая аудитория
Проект взят, как теоретический, поэтому продуктовые метрики взяты у Яндекс Навигатора, исходя из <br> того, что многие водители и пассажиры пользуются именно ими.

- 24 млн. активных пользователей в месяц;
- 59% аудитории - в возрасте от 25 до 44 лет;
- 35% - женщины;
- 65% - мужчины;
- 66% с доходом выше среднего.

Также для статистики взяты данные Яндекс Go:
Количество активных пользователей в месяц - 43,5 млн.
Количество водителей - около 170 000.

## 2. Расчет нагрузки
- 24 млн. активных пользователей в месяц;
- дневной охват может варьироваться от 2,4 до 7,2 миллиона пользователей;
- Количество парковок всего - 344 150.

### Рассмотрим основные типы данных:
- Информация о парковке занимает ~1 Кб
- Информация о пользователе занимает ~1Кб
- Общий объем, который занимает карта равняется 200Тб
- Объем карты для одного города равен примерно 200Мб
- При разделении карты города на секции, объем памяти условной секции равен 192Кб

### Общий объем памяти за месяц равен:
200Тб + 24 * 10^6 * 1Кб / 1024 / 1024 + 344 150  * 1Кб / 1024 / 1024 = 222.94 Тб

### Среднее количество действий пользователя:
| Действие | Количество действий(в среднем) |
|---------------------|---------------------|
| Авторизация | 2 раза в год |
| Просмотр мест на парковке | 6 раз в день |
| Просмотр избранного | 2 раза в день |
| Добавление в избранное | 1 раз в месяц |

В среднем пользователь просматривает карту 2 - 3 раза в день.<br>
В среднем пользователь при просмотре карты открывает 3 секции. <br>
Удаление парковки из избранного и регистрация рассматриваться не будут, т.к. это происходит крайне редко.

### RPS
DAU = 7.2 M <br>
RPS = Количесво действий на пользователя * DAU / 86 400 <br>
RPD = Количесво действий на пользователя * DAU <br>
| Действие | RPS | RPD |
|---------------------|---------------------|---------------------|
| Авторизация | 0.46 | 39452.05 |
| Просмотр секций карты | 100 | 8 640 000 |
| Просмотр мест на парковке | 500 | 43 200 000 |
| Просмотр избранного | 166.67 | 14 400  000 |
| Добавление в избранное | 2.78 | 240 000 |
RPS просмотра секций карты равен 100, исходя из максимума в источнике 3.

**RPS(общий)** = 769.91<br>
**RPS(пиковый)** = 1154.865<br>

### Сетевой трафик
| Действие | Трафик | Пиковый трафик |
|---------------------|---------------------|---------------------|
| Авторизация | 0.46 Кб/c | 0.92 Кб/c |
| Просмотр секций карты | 18.75 Мб/c | 37.5 Мб/c |
| Просмотр мест на парковке | 500 Кб/c| 1 000 Кб/c|
| Просмотр избранного | 166.67 Кб/c | 333.34 Кб/c |
| Добавление в избранное | 2.78 Кб/c | 5.56 Кб/c |

## 3. Глобальная балансировка

Целевой аудиторией сервиса являются пользователи России, поэтому необходимо проанализировать плотность населения, как на рисунке ниже, и оптимально расположить ЦОДы:
![image](https://github.com/AlexnadrLarin/highload/assets/47739783/a15de64e-d8fc-4ef6-b59a-b36e5baefc07)

Большая часть пользователей находиться в Европейской части России, поэтому оптимально расположить датацентры именно там:<br>
- Москва: Как столица и крупнейший город России, Москва является центром технологического развития и имеет крупные узлы связи;
- Санкт-Петербург: Второй по величине город в России, он также имеет развитую инфраструктуру и крупные центры данных;
- Екатеринбург: Расположенный в центре России, он может обеспечить хорошее покрытие для регионов Урала и Сибири.

Использую GeoDNS определяется физически ближайший к пользователю ЦОД. Далее с помощью BGP Anycast найти для каждого района свой ЦОД, чтоб улучшить балансировку.

## 4. Локальная балансировка

Для картографического сервиса предлагаю использовать следующие технологии:<br>
### 1. Kubernetes
Kubernetes обеспечивает масштабируемость, отказоустойчивость и управление ресурсами, что важно для сервисов, <br> которые работают с картами, особенно при обработке больших объемов запросов.

Причины выбора Kubernetes:<br>
**- Масштабируемость:** Kubernetes позволяет легко масштабировать сервисы горизонтально и вертикально в зависимости от нагрузки. Это полезно для данного сервиса, который может иметь пиковые нагрузки в определенные периоды времени;

**- Управление ресурсами:** Kubernetes позволяет управлять ресурсами контейнеров, что позволяет оптимизировать использование вычислительных ресурсов и обеспечить стабильную производительность сервиса;

**- Отказоустойчивость:** Kubernetes автоматически управляет перезапуском контейнеров в случае их сбоев;

**- Управление конфигурацией и развертыванием:** Kubernetes предоставляет инструменты для управления конфигурацией и автоматизации развертывания, что упрощает процесс управления и обновлениями сервиса.

### 2. Nginx на уровне L7
Nginx будет использоваться для балансировки нагрузки между контейнерами Kubernetes.

Причины выбора Nginx:<br>
**- Высокая производительность:** Nginx известен своей высокой производительностью и эффективностью в обработке большого количества одновременных соединений и запросов;

**- Оптимизация под медленные клиентские соединения:** Nginx имеет встроенные механизмы для оптимизации работы с медленными клиентами. Например, он может настроить таймауты соединения, управлять буферизацией ответов и настроить параллельные обработчики соединений для улучшения производительности.

Также можно использовать Weighted Least Connections для того, чтобы распределять запросы на сервисы.

### 3. SSL termination
Для шифрования и быстрого автоматического получения SSL-сертификатов будем использовать Let`s Encrypt. Также, чтобы сэкономить время для установки соединения, можно кешировать сессию - использовать Session Cache.

## 5. Логическая схема БД
На рисунке ниже представлена схема базы данных:
![User Interface-Database drawio (2)](https://github.com/AlexnadrLarin/highload/assets/47739783/82388dde-2e1c-4d07-baad-a850087e32f6)

### Описание таблиц <br>
- Таблица users содержит информацию о пользователях (PK - id пользователя, email, хэш-пароль);
- Таблица sessions содержит информацию о сессиях пользователя (PK - id сессии, дата создания, FK - id пользователя);
- Таблица parking_lots содержит информацию о парковках (PK - id парковки, адрес, координаты, количество свободных мест, количество занятых мест);
- Таблица views содержит информацию о парковках (PK - id парковки, id камеры, FK - id парковки);
- Таблица rows содержит информацию о парковках (PK - id ряда, координаты ряда, вместительность ряда, количество свободных мест, дата обновления, FK - id вида);
- Таблица favourites содержит информацию о избранных парковках пользователя (PK - id избранной парковки, FK - id пользователя, id парковки).

### Размер данных <br>
Количество зарегистрированных пользователей возьмем с запасом в 1.5 раза:
- **Users:** <br>
16(UUID) + 50(email) + 50(password) = 116 * 24млн * 1.5 = 3.8895 Гб
<br><br>
- **Sessions:** <br>
50(session_id) + 16(UUID) +  8(date) = 74 * 24млн * 1.5 = 2.481 Гб
<br><br>
- **Favourites:** <br>
4(id) + 16(UUID) +  4(parking_lot_id) = 24 * 24млн * 1.5 * 10 (максимальное количество парковок в избранном) = 0.804 Гб
<br><br>
Количество парковок возьмем из п.2:
- **Parking_lots:** <br>
4(id) + 32(coordinates) + 50(city) + 50(street) + 4(house) = 140 * 344 150 = 45.95 Мб
<br><br>
- **Views:** <br>
4(id) + 4(parking_lot_id) +  4(camera) = 12 * 344 150 * 10(максимальное количество видов) = 39.385 Мб
<br><br>
- **Rows:** <br>
4(id) + 4(view_id) + 32(coordinates) + 4(capacity) + 4(free_places) + 8(date) = 56 * 344150 * 10 (максимальное количество видов) * 2(оптимальное кол-во рядов для распознавания) = 367.592 Мб
<br><br>

## 6. Физическая схема БД
### Выбор хранилища данных
- Таблица **sessions**: Можно использовать Redis(user_id), т.к. он обладает хорошей отказоустойчивостью и производительностью, а также позволяет установить TTL и удалять ненужные данные через какое-то время;
- Таблица **users**: Для этой таблицы лучше всего использовать реляционную базу данных, такую как PostgreSQL. Они обеспечивают эффективное хранение и операции с данными пользователей, такие как аутентификация и управление доступом;
- Таблица **parking_lots, rows, views**: Для информации о парковках лучше всего использовать географическую базу данных, такую как PostGIS (расширение PostgreSQL) с поддержкой геоиндексов. Это позволит эффективно хранить и выполнять пространственные запросы к парковкам, например, поиск ближайших парковок к определенной точке на карте. Для повышения производительности будем использовать Redis для хранения популярных избранных парковок; 
- Таблица **favourites**: Для хранения информации о избранных парковках пользователя также можно использовать реляционную базу данных, поддерживающую быстрый доступ к данным, такой как PostgreSQL. 

### Индексы
 - Таблица **users**: Индекс по email;
 - Таблица **sessions**: Индекс по id пользователяя;
 - Таблица **parking_lots**: Индекс по id;
 - Таблица **favourites**: Индекс по id парковки;.
 - Таблица **views**: Индекс по id парковки;.

### Денормализация
- Объединим таблицы **views** и **parking_lots** в таблицу parking_lots_views.<br>

### Репликация
 - Добавим дополнительный сервер для таблиц parking_lots_views и rows, т.к. в таблице rows хранятся данные, которые часто запрашиваются.

### Физическая схема
![image](https://github.com/AlexnadrLarin/highload/assets/47739783/979d9d31-ff7b-4f59-84fe-f361508dfda6)

## 7. Алгоритм
В сервисе используется алгоритм для распознавания парковочных мест. Он работает по следующему принципу:<br>
1. Берутся данные с камеры в виде кадров.
2. Нейросеть распознает машины, определяет их местоположение на кадре.
3. С помощью этих данных создается матрица счетчиков по размеру кадра, то есть каждому пикселю присваивается свой счётчик.
4. Если область машины попала на нужный пиксель, то счетчик этого пикселя инкрементируется. Чем больше величина счетчика, тем более вероятно, что этот пиксель входит в область парковочного места.
5. Этот алгоритм некоторое время работает, чтобы более точно распознать парковочные места. После того, как матрица счётчиков сформирована, по ней создается матрица булевых значений, которая нужна для определения занятости парковочного места.
   
## 8. Технологии
| Технология | Область применения | Мотивация |
|---------------------|---------------------|---------------------|
| Typescript | Frontend | Большая популярность, поддержка яндекс карт |
| Golang | Backend  | Асинхронность, строгая типизация |
| Nginx | Балансировщик  | Удобный, легковесный и надежный балансировщик |
| Redis | Кеширование сессий и избранного  | Простой в обслуживании, лекговесный, есть TTL |
| PostgreSQL | DataBase | Популярный и надежный сервис, большой функционал, реляционная база данных |
| PostGis | DataBase | Возможность работы с координатами |
| Kubernetes | DevOps | Предоставляется автоматическая масштабируемость, отказоустойчивость и удобное управление ресурсами |

## 9. Схема проекта

## 10. Надежность
Kubernetes позволяет равномерно распределять нагрузку между контейнерами, чтобы предотвратить перегрузку и обеспечить стабильность работы. В случае падения контейнеров, автоматически сработает перезапуск, также Kubernetes обеспечивает практически мгновенное горизонтальное масштабирование. 

Для БД - использование реплицирования обеспечивают отказоустойчивость при многочисленных транзакциях на чтение / запись. Добавим сервис-очрердь, к примеру RabbitMQ, который снизит нагрузку на БД. Также необходимы резервное копирование и снапшоты для возможности восстановления.

Для ДЦ - расставить ЦОДы в нескольких городах и использовать несколько провайдеров.

Также необходимы:
- Сбор и хранение логов с возможностью трассировки для отладки и анализа инцидентов;
- Регулярное статистическое профилирование для выявления проблем производительности;
- Разделение системы на независимые сервисы, чтобы сбои разных систем не влияли друг на друга.



### Источники:
1. [Статистика Яндекс Go](https://inclient.ru/yandex-stats/#go)<br>
2. [Статистика Яндекс Карт](https://www.retail.ru/rbc/pressreleases/prodvizhenie-biznesa-v-puti-geomediynaya-reklama-kak-instrument-marketinga-v-2023/)
3. [Информация о тайлах карты](https://yandex.ru/dev/tiles/doc/ru/)






